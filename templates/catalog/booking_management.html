{% extends "base.html" %}
{% load static %}

{% block title %}Buchungsverwaltung – Play & Jump{% endblock %}

{% block extra_css %}
<!-- FullCalendar CSS -->
<link href='https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.10/main.min.css' rel='stylesheet' />
<link href='https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.10/main.min.css' rel='stylesheet' />
<link href='https://cdn.jsdelivr.net/npm/@fullcalendar/timegrid@6.1.10/main.min.css' rel='stylesheet' />
<link href='https://cdn.jsdelivr.net/npm/@fullcalendar/list@6.1.10/main.min.css' rel='stylesheet' />
<link href='https://cdn.jsdelivr.net/npm/@fullcalendar/interaction@6.1.10/main.min.css' rel='stylesheet' />

<style>
    .fc-event {
        cursor: pointer;
    }
    
    .fc-event:hover {
        opacity: 0.8;
    }
    
    .booking-filters {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .calendar-container {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .status-legend {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    
    .status-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .status-color {
        width: 20px;
        height: 20px;
        border-radius: 4px;
    }
    
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }
    
    .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 20px;
        border-radius: 8px;
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
    }
    
    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }
    
    .close:hover {
        color: black;
    }
    
    .form-group {
        margin-bottom: 15px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }
    
    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
    }
    
    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: background-color 0.3s;
    }
    
    .btn-primary {
        background-color: #20B2AA;
        color: white;
    }
    
    .btn-primary:hover {
        background-color: #1a8f89;
    }
    
    .btn-danger {
        background-color: #dc3545;
        color: white;
    }
    
    .btn-danger:hover {
        background-color: #c82333;
    }
    
    .btn-secondary {
        background-color: #6c757d;
        color: white;
    }
    
    .btn-secondary:hover {
        background-color: #5a6268;
    }
    
    .btn-group {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-4">
                <span class="text-teal-600">Buchungsverwaltung</span>
            </h1>
            <p class="text-xl text-gray-600 max-w-3xl mx-auto">
                Verwalten Sie alle Buchungen und planen Sie die Verfügbarkeit Ihrer Produkte.
            </p>
        </div>

        <!-- Filters -->
        <div class="booking-filters">
            <div class="flex flex-col lg:flex-row gap-4 items-center justify-between">
                <div class="flex items-center gap-4">
                    <label class="text-gray-700 font-medium">Produkt filtern:</label>
                    <select id="product-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                        <option value="">Alle Produkte</option>
                        {% for product in products %}
                        <option value="{{ product.id }}" {% if selected_product == product.id|stringformat:"s" %}selected{% endif %}>
                            {{ product.title }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="flex gap-2">
                    <button id="add-booking-btn" class="button-coral-effect btn btn-primary">
                        <i class="fas fa-plus mr-2"></i>Neue Buchung
                    </button>
                    <button id="refresh-calendar" class="button-coral-effect btn btn-secondary">
                        <i class="fas fa-sync-alt mr-2"></i>Aktualisieren
                    </button>
                </div>
            </div>
        </div>

        <!-- Status Legend -->
        <div class="status-legend">
            <div class="status-item">
                <div class="status-color" style="background-color: #ffc107;"></div>
                <span>Ausstehend</span>
            </div>
            <div class="status-item">
                <div class="status-color" style="background-color: #28a745;"></div>
                <span>Bestätigt</span>
            </div>
            <div class="status-item">
                <div class="status-color" style="background-color: #dc3545;"></div>
                <span>Storniert</span>
            </div>
            <div class="status-item">
                <div class="status-color" style="background-color: #6c757d;"></div>
                <span>Abgeschlossen</span>
            </div>
        </div>

        <!-- Calendar -->
        <div class="calendar-container">
            <div id="calendar"></div>
        </div>
    </div>
</div>

<!-- Add/Edit Booking Modal -->
<div id="booking-modal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2 id="modal-title" class="text-2xl font-bold mb-4">Neue Buchung</h2>
        
        <form id="booking-form">
            <input type="hidden" id="booking-id" name="booking_id">
            
            <div class="form-row">
                <div class="form-group">
                    <label for="customer-name">Kundenname *</label>
                    <input type="text" id="customer-name" name="customer_name" required>
                </div>
                <div class="form-group">
                    <label for="customer-email">E-Mail *</label>
                    <input type="email" id="customer-email" name="customer_email" required>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="customer-phone">Telefon</label>
                    <input type="tel" id="customer-phone" name="customer_phone">
                </div>
                <div class="form-group">
                    <label for="product-select">Produkt *</label>
                    <select id="product-select" name="product_id" required onchange="updateProductPrice()">
                        <option value="">Produkt auswählen</option>
                        {% for product in products %}
                        <option value="{{ product.id }}" data-price="{{ product.price|default:0 }}">
                            {{ product.title }} {% if product.price %}({{ product.price }}€/Tag){% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="start-date">Startdatum *</label>
                    <input type="date" id="start-date" name="start_date" required>
                </div>
                <div class="form-group">
                    <label for="end-date">Enddatum *</label>
                    <input type="date" id="end-date" name="end_date" required>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="text-sm font-medium text-gray-700 mb-2">
                        Preis pro Tag: <span id="price_per_day" class="font-bold text-teal-600">0€</span>
                    </label>
                    <div class="bg-gray-100 p-3 rounded-md">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Anzahl Tage:</span>
                            <span id="duration_days" class="font-bold text-teal-600">1</span>
                        </div>
                        <div class="flex justify-between items-center mt-1">
                            <span class="text-sm text-gray-600">Gesamtpreis:</span>
                            <span id="calculated_total" class="font-bold text-teal-600 text-lg">0€</span>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="status">Status</label>
                    <select id="status" name="status">
                        <option value="pending">Ausstehend</option>
                        <option value="confirmed">Bestätigt</option>
                        <option value="cancelled">Storniert</option>
                        <option value="completed">Abgeschlossen</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label for="notes">Notizen</label>
                <textarea id="notes" name="notes" rows="3"></textarea>
            </div>
            
            <div class="btn-group">
                <button type="submit" class="button-coral-effect btn btn-primary">Speichern</button>
                <button type="button" id="delete-booking" class="button-coral-effect btn btn-danger" style="display: none;">Löschen</button>
                <button type="button" id="cancel-booking" class="button-coral-effect btn btn-secondary">Abbrechen</button>
            </div>
        </form>
    </div>
</div>

<!-- Booking Details Modal -->
<div id="details-modal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2 class="text-2xl font-bold mb-4">Buchungsdetails</h2>
        <div id="booking-details"></div>
        <div class="btn-group">
            <button id="edit-booking" class="button-coral-effect btn btn-primary">Bearbeiten</button>
            <button type="button" class="button-coral-effect btn btn-secondary" onclick="closeModal('details-modal')">Schließen</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- FullCalendar JavaScript -->
<script src='https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.10/main.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.10/main.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/@fullcalendar/timegrid@6.1.10/main.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/@fullcalendar/list@6.1.10/main.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/@fullcalendar/interaction@6.1.10/main.min.js'></script>

<script>
let calendar;
let currentBookingId = null;

document.addEventListener('DOMContentLoaded', function() {
    initializeCalendar();
    setupEventListeners();
});

function initializeCalendar() {
    const calendarEl = document.getElementById('calendar');
    
    calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'de',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,listWeek'
        },
        buttonText: {
            today: 'Heute',
            month: 'Monat',
            week: 'Woche',
            list: 'Liste'
        },
        height: 'auto',
        selectable: true,
        selectMirror: true,
        dayMaxEvents: true,
        weekends: true,
        events: function(info, successCallback, failureCallback) {
            // Получаем данные бронирований
            fetch(`{% url 'catalog:get_bookings_data' %}?start=${info.startStr}&end=${info.endStr}`)
                .then(response => response.json())
                .then(data => {
                    successCallback(data);
                })
                .catch(error => {
                    console.error('Error fetching events:', error);
                    failureCallback(error);
                });
        },
        select: function(info) {
            // При выборе даты открываем форму создания бронирования
            openBookingModal('add', {
                start_date: info.startStr,
                end_date: info.endStr
            });
        },
        eventClick: function(info) {
            // При клике на событие показываем детали
            showBookingDetails(info.event);
        },
        eventDrop: function(info) {
            // При перетаскивании события обновляем даты
            updateBookingDates(info.event);
        },
        eventResize: function(info) {
            // При изменении размера события обновляем даты
            updateBookingDates(info.event);
        }
    });
    
    calendar.render();
}

function setupEventListeners() {
    // Фильтр по продукту
    document.getElementById('product-filter').addEventListener('change', function() {
        refreshCalendar();
    });
    
    // Кнопка добавления бронирования
    document.getElementById('add-booking-btn').addEventListener('click', function() {
        openBookingModal('add');
    });
    
    // Кнопка обновления календаря
    document.getElementById('refresh-calendar').addEventListener('click', function() {
        refreshCalendar();
    });
    
    // Форма бронирования
    document.getElementById('booking-form').addEventListener('submit', function(e) {
        e.preventDefault();
        saveBooking();
    });
    
    // Кнопка отмены
    document.getElementById('cancel-booking').addEventListener('click', function() {
        closeModal('booking-modal');
    });
    
    // Кнопка удаления
    document.getElementById('delete-booking').addEventListener('click', function() {
        deleteBooking();
    });
    
    // Кнопка редактирования
    document.getElementById('edit-booking').addEventListener('click', function() {
        closeModal('details-modal');
        openBookingModal('edit', currentBookingData);
    });
    
    // Закрытие модальных окон
    document.querySelectorAll('.close').forEach(closeBtn => {
        closeBtn.addEventListener('click', function() {
            this.closest('.modal').style.display = 'none';
        });
    });
    
    // Обработчики для полей дат
    document.getElementById('start-date').addEventListener('change', updatePriceDisplay);
    document.getElementById('end-date').addEventListener('change', updatePriceDisplay);
    
    // Закрытие модальных окон при клике вне их
    window.addEventListener('click', function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = 'none';
        }
    });
}

function refreshCalendar() {
    const productFilter = document.getElementById('product-filter').value;
    const url = `{% url 'catalog:get_bookings_data' %}${productFilter ? '?product=' + productFilter : ''}`;
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            calendar.removeAllEvents();
            calendar.addEventSource(data);
        })
        .catch(error => {
            console.error('Error refreshing calendar:', error);
        });
}

function openBookingModal(mode, data = {}) {
    const modal = document.getElementById('booking-modal');
    const title = document.getElementById('modal-title');
    const form = document.getElementById('booking-form');
    const deleteBtn = document.getElementById('delete-booking');
    
    if (mode === 'add') {
        title.textContent = 'Neue Buchung';
        form.reset();
        currentBookingId = null;
        deleteBtn.style.display = 'none';
        
        // Сбрасываем отображение цены
        document.getElementById('price_per_day').textContent = '0€';
        document.getElementById('duration_days').textContent = '1';
        document.getElementById('calculated_total').textContent = '0€';
        
        // Устанавливаем выбранные даты
        if (data.start_date) {
            document.getElementById('start-date').value = data.start_date;
        }
        if (data.end_date) {
            document.getElementById('end-date').value = data.end_date;
        }
        
        // Обновляем отображение цены после установки дат
        if (data.start_date && data.end_date) {
            updatePriceDisplay();
        }
    } else {
        title.textContent = 'Buchung bearbeiten';
        currentBookingId = data.id;
        deleteBtn.style.display = 'block';
        
        // Заполняем форму данными
        fillBookingForm(data);
    }
    
    modal.style.display = 'block';
}

function fillBookingForm(data) {
    document.getElementById('customer-name').value = data.extendedProps.customer_name || '';
    document.getElementById('customer-email').value = data.extendedProps.customer_email || '';
    document.getElementById('customer-phone').value = data.extendedProps.customer_phone || '';
    document.getElementById('product-select').value = data.extendedProps.product_id || '';
    document.getElementById('start-date').value = data.startStr || '';
    document.getElementById('end-date').value = data.endStr || '';
    document.getElementById('status').value = data.extendedProps.status || 'pending';
    document.getElementById('notes').value = data.extendedProps.notes || '';
    
    // Обновляем отображение цены
    updatePriceDisplay();
}

function saveBooking() {
    const formData = new FormData(document.getElementById('booking-form'));
    const data = {
        customer_name: formData.get('customer_name'),
        customer_email: formData.get('customer_email'),
        customer_phone: formData.get('customer_phone'),
        product_id: formData.get('product_id'),
        start_date: formData.get('start_date'),
        end_date: formData.get('end_date'),
        status: formData.get('status'),
        notes: formData.get('notes')
    };
    
    const url = currentBookingId 
        ? `{% url 'catalog:update_booking' 0 %}`.replace('0', currentBookingId)
        : `{% url 'catalog:create_booking' %}`;
    
    const method = currentBookingId ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            closeModal('booking-modal');
            refreshCalendar();
            showNotification(result.message, 'success');
        } else {
            showNotification('Fehler: ' + result.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error saving booking:', error);
        showNotification('Fehler beim Speichern der Buchung', 'error');
    });
}

function deleteBooking() {
    if (!currentBookingId) return;
    
    if (!confirm('Sind Sie sicher, dass Sie diese Buchung löschen möchten?')) {
        return;
    }
    
    fetch(`{% url 'catalog:update_booking' 0 %}`.replace('0', currentBookingId), {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            closeModal('booking-modal');
            refreshCalendar();
            showNotification(result.message, 'success');
        } else {
            showNotification('Fehler: ' + result.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error deleting booking:', error);
        showNotification('Fehler beim Löschen der Buchung', 'error');
    });
}

function showBookingDetails(event) {
    const modal = document.getElementById('details-modal');
    const detailsDiv = document.getElementById('booking-details');
    
    currentBookingData = {
        id: event.id,
        startStr: event.startStr,
        endStr: event.endStr,
        extendedProps: event.extendedProps
    };
    
    detailsDiv.innerHTML = `
        <div class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <strong>Kunde:</strong> ${event.extendedProps.customer_name}
                </div>
                <div>
                    <strong>E-Mail:</strong> ${event.extendedProps.customer_email}
                </div>
                <div>
                    <strong>Telefon:</strong> ${event.extendedProps.customer_phone || 'Nicht angegeben'}
                </div>
                <div>
                    <strong>Produkt:</strong> ${event.extendedProps.product_title}
                </div>
                <div>
                    <strong>Startdatum:</strong> ${new Date(event.startStr).toLocaleDateString('de-DE')}
                </div>
                <div>
                    <strong>Enddatum:</strong> ${new Date(event.endStr).toLocaleDateString('de-DE')}
                </div>
                <div>
                    <strong>Dauer:</strong> ${event.extendedProps.duration_days} Tag(e)
                </div>
                <div>
                    <strong>Preis:</strong> ${event.extendedProps.total_price}€
                </div>
                <div>
                    <strong>Status:</strong> ${getStatusText(event.extendedProps.status)}
                </div>
            </div>
            ${event.extendedProps.notes ? `<div><strong>Notizen:</strong> ${event.extendedProps.notes}</div>` : ''}
        </div>
    `;
    
    modal.style.display = 'block';
}

// Функция для расчета цены на основе выбранных дат
function updatePriceDisplay() {
    const startDate = document.getElementById('start-date').value;
    const endDate = document.getElementById('end-date').value;
    const productSelect = document.getElementById('product-select');
    
    if (startDate && endDate && productSelect.value) {
        const start = new Date(startDate);
        const end = new Date(endDate);
        
        if (end >= start) {
            const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
            const pricePerDay = parseFloat(productSelect.options[productSelect.selectedIndex].dataset.price) || 0;
            const totalPrice = pricePerDay * days;
            
            document.getElementById('duration_days').textContent = days;
            document.getElementById('calculated_total').textContent = totalPrice.toFixed(2) + '€';
        } else {
            document.getElementById('duration_days').textContent = '0';
            document.getElementById('calculated_total').textContent = '0€';
        }
    }
}

// Функция для обновления цены при изменении продукта
function updateProductPrice() {
    const productSelect = document.getElementById('product-select');
    const selectedOption = productSelect.options[productSelect.selectedIndex];
    const price = selectedOption.dataset.price || '0';
    
    document.getElementById('price_per_day').textContent = price + '€';
    updatePriceDisplay();
}

function getStatusText(status) {
    const statusMap = {
        'pending': 'Ausstehend',
        'confirmed': 'Bestätigt',
        'cancelled': 'Storniert',
        'completed': 'Abgeschlossen'
    };
    return statusMap[status] || status;
}

function updateBookingDates(event) {
    const data = {
        start_date: event.startStr,
        end_date: event.endStr
    };
    
    fetch(`{% url 'catalog:update_booking' 0 %}`.replace('0', event.id), {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showNotification('Buchung erfolgreich aktualisiert', 'success');
        } else {
            showNotification('Fehler: ' + result.error, 'error');
            refreshCalendar(); // Восстанавливаем исходное состояние
        }
    })
    .catch(error => {
        console.error('Error updating booking:', error);
        showNotification('Fehler beim Aktualisieren der Buchung', 'error');
        refreshCalendar(); // Восстанавливаем исходное состояние
    });
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${
        type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
