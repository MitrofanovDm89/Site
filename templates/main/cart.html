{% extends "base.html" %}
{% load static %}

{% block title %}Warenkorb – Play & Jump{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-4">
                <span class="text-teal-600">Warenkorb</span>
            </h1>
            <p class="text-xl text-gray-600">
                Überprüfen Sie Ihre Auswahl und senden Sie eine Anfrage.
            </p>
        </div>

        {% if cart_items %}
        <!-- Cart Items -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">Ausgewählte Produkte</h2>
            
            <div class="space-y-4">
                {% for item in cart_items %}
                <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg"
                     {% if item.start_date and item.end_date %}
                     data-start-date="{{ item.start_date }}"
                     data-end-date="{{ item.end_date }}"
                     {% endif %}>
                    <div class="flex items-center space-x-4">
                        <div class="flex-shrink-0">
                            {% if item.image %}
                                <img src="{{ item.image.url }}" alt="{{ item.title }}" class="w-16 h-16 object-cover rounded-lg">
                            {% else %}
                                <div class="w-16 h-16 bg-teal-500 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-box text-white text-xl"></i>
                                </div>
                            {% endif %}
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">{{ item.title }}</h3>
                            <p class="text-gray-600">Preis: {{ item.price_per_day }}€/Tag</p>
                            
                            {% if item.start_date and item.end_date %}
                            <div class="mt-2 space-y-1">
                                <div class="flex items-center text-sm text-gray-600">
                                    <i class="fas fa-calendar mr-2"></i>
                                    <span>Von: {{ item.start_date|date:"d.m.Y" }} bis: {{ item.end_date|date:"d.m.Y" }}</span>
                                </div>
                                <div class="flex items-center text-sm text-gray-600">
                                    <i class="fas fa-clock mr-2"></i>
                                    <span>{{ item.duration_days }} Tag(e)</span>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <div class="text-right">
                            <p class="text-lg font-bold text-teal-600">{{ item.subtotal }}€</p>
                        </div>
                        
                        <div class="flex items-center space-x-2">
                            {% if item.start_date and item.end_date %}
                            <button onclick="editDates('{{ item.cart_key }}', '{{ item.start_date }}', '{{ item.end_date }}', {{ item.price_per_day|default:0|floatformat:0 }})" 
                                    class="button-coral-effect text-blue-500 hover:text-blue-700 transition-colors p-2 rounded-lg hover:bg-blue-50" title="Daten bearbeiten">
                                <i class="fas fa-edit"></i>
                            </button>
                            {% endif %}
                            
                            <button onclick="removeFromCart('{{ item.cart_key }}')" 
                                    class="button-coral-effect text-red-500 hover:text-red-700 transition-colors p-2 rounded-lg hover:bg-red-50" title="Entfernen">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- Total -->
            <div class="mt-6 pt-6 border-t border-gray-200">
                <div class="flex justify-between items-center">
                    <span class="text-2xl font-bold text-gray-900">Gesamtpreis:</span>
                    <span class="text-3xl font-bold text-teal-600">{{ total_price }}€</span>
                </div>
            </div>
        </div>

        <!-- Delivery Options -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">Lieferoptionen</h2>
            
            <div class="space-y-4">
                                 <div class="flex items-center">
                     <input type="radio" id="delivery-pickup" name="delivery_option" value="pickup" 
                            {% if delivery_option == 'pickup' %}checked{% endif %}
                            onchange="updateDeliveryOption('pickup')"
                            class="w-4 h-4 text-teal-600 bg-gray-100 border-gray-300 focus:ring-teal-500">
                     <label for="delivery-pickup" class="ml-3 text-lg font-medium text-gray-900">
                         Selbstabholung (kostenlos)
                     </label>
                     {% if delivery_address %}
                     <button onclick="openDeliveryDetailsModal()" 
                             class="button-coral-effect ml-3 text-sm text-teal-600 hover:text-teal-800 underline">
                         Details bearbeiten
                     </button>
                     {% endif %}
                 </div>
                
                <div class="flex items-center">
                    <input type="radio" id="delivery-delivery" name="delivery_option" value="delivery" 
                           {% if delivery_option == 'delivery' %}checked{% endif %}
                           onchange="updateDeliveryOption('delivery')"
                           class="w-4 h-4 text-teal-600 bg-gray-100 border-gray-300 focus:ring-teal-500">
                    <label for="delivery-delivery" class="ml-3 text-lg font-medium text-gray-900">
                        Lieferung + Aufbau/Abbau (60€)
                    </label>
                    {% if delivery_address %}
                    <button onclick="openDeliveryDetailsModal()" 
                            class="button-coral-effect ml-3 text-sm text-teal-600 hover:text-teal-800 underline">
                        Details bearbeiten
                    </button>
                    {% endif %}
                </div>
                
                {% if delivery_address %}
                <div class="ml-7 mt-3 p-4 bg-teal-50 rounded-lg border border-teal-200">
                    <div class="text-sm text-teal-800">
                        <div class="font-medium mb-2">Lieferdetails (gespeichert):</div>
                        
                        <div><strong>Adresse:</strong> {{ delivery_address }}</div>
                        {% if delivery_datetime %}
                        <div><strong>Lieferung:</strong> {{ delivery_datetime|date:"d.m.Y H:i" }}</div>
                        {% else %}
                        <div><strong>Lieferung:</strong> <span class="text-red-500">Nicht angegeben</span></div>
                        {% endif %}
                        {% if return_datetime %}
                        <div><strong>Rückgabe:</strong> {{ return_datetime|date:"d.m.Y H:i" }}</div>
                        {% else %}
                        <div><strong>Rückgabe:</strong> <span class="text-red-500">Nicht angegeben</span></div>
                        {% endif %}
                        {% if delivery_instructions %}
                        <div><strong>Anweisungen:</strong> {{ delivery_instructions }}</div>
                        {% else %}
                        <div><strong>Anweisungen:</strong> <span class="text-gray-500">Keine Anweisungen</span></div>
                        {% endif %}
                        <div class="mt-2 text-xs text-teal-600">
                            <i class="fas fa-info-circle mr-1"></i>
                            Wählen Sie "Lieferung + Aufbau/Abbau" um diese Details zu verwenden
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <div class="mt-4 p-4 bg-blue-50 rounded-lg">
                    <p class="text-sm text-blue-800">
                        <strong>Hinweis:</strong> Die Lieferung erfolgt im Umkreis von 30 km von unserem Unternehmen. 
                        Inklusive Aufbau, Abbau und Demontage der Ausrüstung.
                    </p>
                </div>
            </div>
            
            <!-- Final Total -->
            <div class="mt-6 pt-6 border-t border-gray-200">
                <div class="space-y-2">
                    <div class="flex justify-between items-center text-lg">
                        <span class="text-gray-700">Mietpreis:</span>
                        <span class="font-semibold text-gray-900">{{ total_price }}€</span>
                    </div>
                    <div class="flex justify-between items-center text-lg">
                        <span class="text-gray-700">Lieferung:</span>
                        <span class="font-semibold text-gray-900" data-delivery-cost>{{ delivery_cost }}€</span>
                    </div>
                    <div class="flex justify-between items-center text-2xl font-bold text-teal-600 pt-2 border-t border-gray-200">
                        <span>Gesamt:</span>
                        <span data-final-total>{{ final_total }}€</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Inquiry Form -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">Anfrage senden</h2>
            
            <form id="inquiry-form" class="space-y-6">
                {% csrf_token %}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="customer-name" class="block text-sm font-medium text-gray-700 mb-2">
                            Name (optional)
                        </label>
                        <input type="text" 
                               id="customer-name" 
                               name="customer_name"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
                               placeholder="Ihr Name">
                    </div>
                    
                    <div>
                        <label for="customer-email" class="block text-sm font-medium text-gray-700 mb-2">
                            E-Mail <span class="text-red-500">*</span>
                        </label>
                        <input type="email" 
                               id="customer-email" 
                               name="customer_email"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
                               placeholder="ihre.email@example.com"
                               required>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="customer-phone" class="block text-sm font-medium text-gray-700 mb-2">
                            Telefon (optional)
                        </label>
                        <input type="tel" 
                               id="customer-phone" 
                               name="customer_phone"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
                               placeholder="+49 123 456789">
                    </div>
                    
                    <div class="flex items-end">
                        <div class="text-sm text-gray-600">
                            <p><span class="text-red-500">*</span> Mindestens E-Mail oder Telefon erforderlich</p>
                        </div>
                    </div>
                </div>
                
                <div>
                    <label for="comment" class="block text-sm font-medium text-gray-700 mb-2">
                        Kommentar (optional)
                    </label>
                    <textarea id="comment" 
                              name="comment"
                              rows="4"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
                              placeholder="Zusätzliche Informationen oder Wünsche..."></textarea>
                </div>
                
                <!-- Privacy Policy Consent -->
                <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                    <div class="flex items-start space-x-3">
                        <input type="checkbox" 
                               id="privacy-consent" 
                               name="privacy_consent"
                               class="mt-1 h-4 w-4 text-teal-600 focus:ring-teal-500 border-gray-300 rounded"
                               required>
                        <label for="privacy-consent" class="text-sm text-gray-700 leading-relaxed">
                            <span class="text-red-500">*</span> 
                            Ich stimme der Verarbeitung meiner personenbezogenen Daten durch die Firma 
                            <strong>Play & Jump, Hüpfburg Vermietung</strong> mit Sitz in der 
                            <strong>Niederwaldstraße 4, 76437 Rastatt</strong>, zu Zwecken der Beantwortung zu. 
                            Ich habe das Recht, auf meine personenbezogenen Daten zuzugreifen und diese zu bearbeiten.
                        </label>
                    </div>
                </div>
                
                <div class="flex justify-center">
                    <button type="submit" 
                            class="button-coral-effect px-8 py-3 bg-teal-600 text-white text-lg font-semibold rounded-lg hover:bg-teal-700 transition-colors focus:ring-2 focus:ring-teal-500 focus:ring-offset-2">
                        <i class="fas fa-paper-plane mr-2"></i>
                        Anfrage senden
                    </button>
                </div>
            </form>
        </div>
        
        {% else %}
        <!-- Empty Cart -->
        <div class="bg-white rounded-lg shadow-md p-12 text-center">
            <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-shopping-cart text-gray-400 text-3xl"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Ihr Warenkorb ist leer</h2>
            <p class="text-gray-600 mb-8">
                Fügen Sie Produkte aus unserem Katalog hinzu, um eine Anfrage zu senden.
            </p>
            <a href="{% url 'catalog:catalog_index' %}" 
               class="button-coral-effect inline-flex items-center px-6 py-3 bg-teal-600 text-white font-semibold rounded-lg hover:bg-teal-700 transition-colors">
                <i class="fas fa-arrow-left mr-2"></i>
                Zum Katalog
            </a>
        </div>
        {% endif %}
    </div>
</div>

<!-- Success Modal -->
<div id="success-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg p-8 max-w-md w-full text-center">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-check text-green-600 text-2xl"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-900 mb-2">Anfrage gesendet!</h3>
            <p class="text-gray-600 mb-6" id="success-message">
                Wir haben Ihre Anfrage erhalten und werden uns in Kürze bei Ihnen melden.
            </p>
            <button onclick="closeSuccessModal()" 
                    class="button-coral-effect w-full px-4 py-2 bg-teal-600 text-white font-semibold rounded-lg hover:bg-teal-700 transition-colors">
                Schließen
            </button>
        </div>
    </div>
</div>

<!-- Date Edit Modal -->
<div id="date-edit-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-900">Daten bearbeiten</h3>
                <button onclick="closeDateEditModal()" class="button-coral-effect text-gray-400 hover:text-gray-600 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Startdatum *</label>
                    <input type="date" id="edit-start-date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Enddatum *</label>
                    <input type="date" id="edit-end-date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                </div>
                
                <div class="bg-gray-50 p-4 rounded-lg">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm text-gray-600">Preis pro Tag:</span>
                        <span id="edit-price-per-day" class="font-bold text-teal-600">0€</span>
                    </div>
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm text-gray-600">Anzahl Tage:</span>
                        <span id="edit-duration-days" class="font-bold text-teal-600">1</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">Gesamtpreis:</span>
                        <span id="edit-total-price" class="font-bold text-teal-600 text-lg">0€</span>
                    </div>
                </div>
                
                <div class="flex gap-3 pt-4">
                    <button onclick="closeDateEditModal()" 
                            class="button-coral-effect flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                        Abbrechen
                    </button>
                    <button onclick="saveDateChanges()" 
                            class="button-coral-effect flex-1 px-4 py-2 bg-teal-500 text-white rounded-lg hover:shadow-lg transition-all duration-300">
                        Speichern
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delivery Details Modal -->
<div id="delivery-details-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-900">Lieferdetails eingeben</h3>
                <button onclick="closeDeliveryDetailsModal()" class="button-coral-effect text-gray-400 hover:text-gray-600 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="delivery-details-form" class="space-y-6">
                <!-- Скрытые поля с датами аренды для валидации -->
                <input type="hidden" id="rental-start-date" value="">
                <input type="hidden" id="rental-end-date" value="">
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Lieferadresse <span class="text-red-500">*</span>
                    </label>
                    <textarea 
                        id="delivery-address" 
                        name="delivery_address"
                        rows="3"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
                        placeholder="Straße, Hausnummer, Stadt, PLZ"
                        required>{{ delivery_address }}</textarea>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Lieferdatum & Zeit <span class="text-red-500">*</span>
                        </label>
                        <input 
                            type="datetime-local" 
                            id="delivery-datetime" 
                            name="delivery_datetime"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
                            value="{{ delivery_datetime }}"
                            min=""
                            max=""
                            required>
                        <div class="mt-1 text-xs text-gray-500" id="delivery-hint">
                            Lieferung muss vor dem ersten Tag der Miete erfolgen.
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Rückgabedatum & Zeit <span class="text-red-500">*</span>
                        </label>
                        <input 
                            type="datetime-local" 
                            id="return-datetime" 
                            name="return_datetime"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
                            value="{{ return_datetime }}"
                            min=""
                            max=""
                            required>
                        <div class="mt-1 text-xs text-gray-500" id="return-hint">
                            Rückgabe muss nach dem letzten Tag der Miete erfolgen.
                        </div>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Zusätzliche Anweisungen (optional)
                    </label>
                    <textarea 
                        id="delivery-instructions" 
                        name="delivery_instructions"
                        rows="3"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
                        placeholder="Z.B. Eingang vom Hof, Hauscode 123, Parkplatz verfügbar...">{{ delivery_instructions }}</textarea>
                </div>
                
                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="closeDeliveryDetailsModal()" 
                            class="button-coral-effect flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                        Abbrechen
                    </button>
                    <button type="submit" 
                            class="button-coral-effect flex-1 px-4 py-2 bg-teal-500 text-white rounded-lg hover:shadow-lg transition-all duration-300">
                        Speichern
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Получаем CSRF токен
function getCSRFToken() {
    const metaTag = document.querySelector('meta[name="csrf-token"]');
    if (metaTag) {
        return metaTag.getAttribute('content');
    }
    return null;
    // Способ доставки не сбрасывается при получении CSRF токена
}

document.getElementById('inquiry-form').addEventListener('submit', function(e) {
    e.preventDefault();
    sendInquiry();
});

function removeFromCart(cartKey) {
    if (!confirm('Sind Sie sicher, dass Sie dieses Produkt aus dem Warenkorb entfernen möchten?')) {
        return;
    }
    
    fetch('{% url "main:remove_from_cart" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken(),
        },
        body: JSON.stringify({
            cart_key: cartKey
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Способ доставки сбрасывается на pickup в backend только если корзина пуста
            location.reload();
        } else {
            showNotification(data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Fehler beim Entfernen des Produkts', 'error');
    });
}

function sendInquiry() {
    const form = document.getElementById('inquiry-form');
    const formData = new FormData(form);
    
    const data = {
        customer_name: formData.get('customer_name'),
        customer_email: formData.get('customer_email'),
        customer_phone: formData.get('customer_phone'),
        comment: formData.get('comment'),
        privacy_consent: formData.get('privacy_consent') === 'on'
    };
    
    // Валидация
    if (!data.customer_email && !data.customer_phone) {
        showNotification('Bitte geben Sie mindestens eine E-Mail-Adresse oder Telefonnummer an.', 'error');
        return;
    }
    
    // Проверка согласия на обработку персональных данных
    const privacyConsent = formData.get('privacy_consent');
    if (!privacyConsent) {
        showNotification('Bitte stimmen Sie der Verarbeitung Ihrer personenbezogenen Daten zu.', 'error');
        return;
    }
    
    // Показываем индикатор загрузки
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Wird gesendet...';
    submitBtn.disabled = true;
    
    fetch('{% url "main:send_inquiry" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken(),
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
            if (result.success) {
                showSuccessModal(result.message);
                // Обновляем счетчик корзины в шапке
                // Способ доставки сбрасывается на pickup в backend при очистке корзины
                updateCartCount(0);
            } else {
                showNotification(result.error, 'error');
            }
        })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Fehler beim Senden der Anfrage', 'error');
    })
    .finally(() => {
        // Восстанавливаем кнопку
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
}

function showSuccessModal(message) {
    document.getElementById('success-message').textContent = message;
    document.getElementById('success-modal').classList.remove('hidden');
    // Способ доставки сбрасывается на pickup в backend при очистке корзины
}

function closeSuccessModal() {
    document.getElementById('success-modal').classList.add('hidden');
    // Перенаправляем на главную страницу
    // Способ доставки уже сброшен на pickup в backend
    window.location.href = '{% url "main:home" %}';
}

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${
        type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 5000);
    // Способ доставки не сбрасывается при показе уведомлений
}

function updateCartCount(count) {
    const cartBadges = document.querySelectorAll('.cart-count');
    cartBadges.forEach(badge => {
        badge.textContent = count;
    });
    // Способ доставки не сбрасывается при обновлении счетчика корзины
}

function updateDeliveryOption(deliveryOption) {
    fetch('{% url "main:update_delivery_option" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken(),
        },
        body: JSON.stringify({
            delivery_option: deliveryOption
        })
    })
    .then(response => response.json())
            .then(data => {
            if (data.success) {
                // Обновляем отображение стоимости
                document.querySelector('[data-delivery-cost]').textContent = data.delivery_cost + '€';
                document.querySelector('[data-final-total]').textContent = data.final_total + '€';
                
                showNotification('Lieferoption aktualisiert', 'success');
                
                // Переключаем радио-кнопку на выбранный способ доставки
                if (deliveryOption === 'delivery') {
                    document.getElementById('delivery-delivery').checked = true;
                    // Открываем модальное окно для деталей
                    setTimeout(() => {
                        openDeliveryDetailsModal();
                    }, 500); // Небольшая задержка для показа уведомления
                } else if (deliveryOption === 'pickup') {
                    document.getElementById('delivery-pickup').checked = true;
                }
                
                // Если выбран pickup, скрываем детали доставки
                if (deliveryOption === 'pickup') {
                    const deliveryDetails = document.querySelector('.ml-7.mt-3.p-4.bg-teal-50');
                    if (deliveryDetails) {
                        deliveryDetails.style.display = 'none';
                    }
                } else if (deliveryOption === 'delivery') {
                    // Если выбран delivery, показываем детали доставки
                    const deliveryDetails = document.querySelector('.ml-7.mt-3.p-4.bg-teal-50');
                    if (deliveryDetails) {
                        deliveryDetails.style.display = 'block';
                    }
                }
            } else {
                showNotification(data.error, 'error');
            }
        })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Fehler beim Aktualisieren der Lieferoption', 'error');
    });
}

// Date editing functions
function editDates(cartKey, startDate, endDate, pricePerDay) {
    console.log('editDates called:', cartKey, startDate, endDate, pricePerDay);
    
    // Store current cart key for editing
    window.currentEditingCartKey = cartKey;
    window.currentEditingPricePerDay = pricePerDay;
    
    // Open date editing modal
    document.getElementById('date-edit-modal').classList.remove('hidden');
    
    // Set current dates
    document.getElementById('edit-start-date').value = startDate;
    document.getElementById('edit-end-date').value = endDate;
    
    // Update price display
    document.getElementById('edit-price-per-day').textContent = pricePerDay + '€';
    
    // Update price calculation
    updateEditPriceCalculation();
    // Способ доставки не сбрасывается при редактировании дат
}

function closeDateEditModal() {
    document.getElementById('date-edit-modal').classList.add('hidden');
    window.currentEditingCartKey = null;
    // Не сбрасываем способ доставки при закрытии модального окна редактирования дат
}

function updateEditPriceCalculation() {
    const startDate = document.getElementById('edit-start-date').value;
    const endDate = document.getElementById('edit-end-date').value;
    
    if (startDate && endDate) {
        const start = new Date(startDate);
        const end = new Date(endDate);
        
        if (end >= start) {
            const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
            const pricePerDay = window.currentEditingPricePerDay || 0;
            const totalPrice = pricePerDay * days;
            
            document.getElementById('edit-duration-days').textContent = days;
            document.getElementById('edit-total-price').textContent = totalPrice + '€';
        } else {
            document.getElementById('edit-duration-days').textContent = '0';
            document.getElementById('edit-total-price').textContent = '0€';
        }
    }
    // Способ доставки не сбрасывается при расчете цены редактирования
}

function saveDateChanges() {
    const startDate = document.getElementById('edit-start-date').value;
    const endDate = document.getElementById('edit-end-date').value;
    
    if (!startDate || !endDate) {
        showNotification('Bitte wählen Sie Start- und Enddatum aus.', 'error');
        return;
    }
    
    const start = new Date(startDate);
    const end = new Date(endDate);
    
    if (end < start) {
        showNotification('Das Enddatum muss nach dem Startdatum liegen.', 'error');
        return;
    }
    
    console.log('Saving date changes:', window.currentEditingCartKey, startDate, endDate);
    
    // Отправляем запрос на обновление дат
    fetch('{% url "main:update_cart_dates" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken(),
        },
        body: JSON.stringify({
            cart_key: window.currentEditingCartKey,
            start_date: startDate,
            end_date: endDate
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Daten erfolgreich aktualisiert!', 'success');
            closeDateEditModal();
            // Способ доставки не сбрасывается при изменении дат
            location.reload(); // Перезагружаем страницу для обновления данных
        } else {
            showNotification(data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Fehler beim Aktualisieren der Daten', 'error');
    });
    // Способ доставки не сбрасывается при сохранении изменений дат
}

// Add event listeners for date inputs
document.addEventListener('DOMContentLoaded', function() {
    const editStartDateInput = document.getElementById('edit-start-date');
    const editEndDateInput = document.getElementById('edit-end-date');
    
    if (editStartDateInput && editEndDateInput) {
        editStartDateInput.addEventListener('change', updateEditPriceCalculation);
        editEndDateInput.addEventListener('change', updateEditPriceCalculation);
    }
    
    // Delivery details form handling
    const deliveryDetailsForm = document.getElementById('delivery-details-form');
    if (deliveryDetailsForm) {
        deliveryDetailsForm.addEventListener('submit', function(e) {
            e.preventDefault();
            saveDeliveryDetails();
        });
    }
    
         // Способ доставки устанавливается сервером, не переопределяем
     
     // При загрузке страницы скрываем/показываем детали доставки в зависимости от выбранного способа
    const pickupRadio = document.getElementById('delivery-pickup');
    const deliveryRadio = document.getElementById('delivery-delivery');
    const deliveryDetails = document.querySelector('.ml-7.mt-3.p-4.bg-teal-50');
    
    if (deliveryDetails) {
        if (pickupRadio && pickupRadio.checked) {
            // Если выбран pickup, скрываем детали
            deliveryDetails.style.display = 'none';
        } else if (deliveryRadio && deliveryRadio.checked) {
            // Если выбран delivery, показываем детали
            deliveryDetails.style.display = 'block';
        }
    }
    
    // Проверяем и исправляем неправильные данные доставки
    validateAndFixDeliveryDates();
});

// Функция для проверки и исправления неправильных данных доставки
function validateAndFixDeliveryDates() {
    const cartItems = document.querySelectorAll('[data-start-date][data-end-date]');
    if (cartItems.length === 0) return;
    
    const firstItem = cartItems[0];
    const rentalStartDate = new Date(firstItem.getAttribute('data-start-date'));
    const rentalEndDate = new Date(firstItem.getAttribute('data-end-date'));
    
    // Проверяем, есть ли сохраненные данные доставки
    const deliveryDetails = document.querySelector('.ml-7.mt-3.p-4.bg-teal-50');
    if (!deliveryDetails) return;
    
    // Если есть неправильные данные, показываем предупреждение
    const returnDateText = deliveryDetails.textContent.match(/Rückgabe:\s*(\d{2}\.\d{2}\.\d{4})/);
    if (returnDateText) {
        const returnDate = new Date(returnDateText[1].split('.').reverse().join('-'));
        if (returnDate < rentalEndDate) {
            // Показываем предупреждение о неправильных данных
            const warningDiv = document.createElement('div');
            warningDiv.className = 'mt-2 p-2 bg-red-100 border border-red-300 rounded text-red-700 text-xs';
            warningDiv.innerHTML = '<i class="fas fa-exclamation-triangle mr-1"></i>Warnung: Rückgabedatum liegt vor dem Ende der Miete. Bitte korrigieren Sie die Lieferdetails.';
            deliveryDetails.appendChild(warningDiv);
        }
    }
}

// Delivery details functions
function setupDeliveryDateConstraints() {
    // Получаем даты аренды из корзины
    const cartItems = document.querySelectorAll('[data-start-date][data-end-date]');
    if (cartItems.length === 0) return;
    
    // Берем первый товар (если несколько, можно расширить логику)
    const firstItem = cartItems[0];
    const startDate = firstItem.getAttribute('data-start-date');
    const endDate = firstItem.getAttribute('data-end-date');
    
    if (!startDate || !endDate) return;
    
    // Устанавливаем ограничения для поля доставки
    const deliveryInput = document.getElementById('delivery-datetime');
    if (deliveryInput) {
        // Минимальная дата: сегодня
        const today = new Date();
        const todayStr = today.toISOString().slice(0, 16);
        deliveryInput.min = todayStr;
        
        // Максимальная дата: первый день аренды (включительно)
        const startDateTime = new Date(startDate + 'T23:59'); // Конец дня
        const startDateTimeStr = startDateTime.toISOString().slice(0, 16);
        deliveryInput.max = startDateTimeStr;
        
        // Обновляем подсказку
        const deliveryHint = document.getElementById('delivery-hint');
        if (deliveryHint) {
            const startDateFormatted = startDateTime.toLocaleDateString('de-DE');
            deliveryHint.textContent = `Lieferung kann bis zum ${startDateFormatted} erfolgen (auch am Tag der Miete).`;
        }
    }
    
    // Устанавливаем ограничения для поля забора
    const returnInput = document.getElementById('return-datetime');
    if (returnInput) {
        // Минимальная дата: день окончания аренды (включительно)
        const endDateTime = new Date(endDate + 'T00:00'); // Начало дня окончания аренды
        const endDateTimeStr = endDateTime.toISOString().slice(0, 16);
        returnInput.min = endDateTimeStr;
        
        // Максимальная дата: +5 дней после окончания аренды
        const maxReturnDate = new Date(endDate);
        maxReturnDate.setDate(maxReturnDate.getDate() + 5);
        const maxReturnDateTimeStr = maxReturnDate.toISOString().slice(0, 16);
        returnInput.max = maxReturnDateTimeStr;
        
        // Обновляем подсказку
        const returnHint = document.getElementById('return-hint');
        if (returnHint) {
            const endDateFormatted = endDateTime.toLocaleDateString('de-DE');
            const maxReturnDateFormatted = maxReturnDate.toLocaleDateString('de-DE');
            returnHint.textContent = `Rückgabe kann ab ${endDateFormatted} bis ${maxReturnDateFormatted} erfolgen (nicht vor dem Ende der Miete).`;
        }
    }
}

function openDeliveryDetailsModal() {
    document.getElementById('delivery-details-modal').classList.remove('hidden');
    
    // Устанавливаем ограничения на поля ввода дат
    setupDeliveryDateConstraints();
    
    // НЕ переключаем автоматически на delivery - пользователь сам выбирает
}

function closeDeliveryDetailsModal() {
    document.getElementById('delivery-details-modal').classList.add('hidden');
    
    // При закрытии модального окна НЕ меняем способ доставки
    // Пользователь сам решает, что выбрать
}

function saveDeliveryDetails() {
    const form = document.getElementById('delivery-details-form');
    const formData = new FormData(form);
    
    const data = {
        delivery_address: formData.get('delivery_address'),
        delivery_datetime: formData.get('delivery_datetime'),
        return_datetime: formData.get('return_datetime'),
        delivery_instructions: formData.get('delivery_instructions')
    };
    
    // Валидация
    if (!data.delivery_address || !data.delivery_datetime || !data.return_datetime) {
        showNotification('Bitte füllen Sie alle erforderlichen Felder aus.', 'error');
        return;
    }
    
    // Дополнительная валидация дат
    const deliveryDate = new Date(data.delivery_datetime);
    const returnDate = new Date(data.return_datetime);
    const today = new Date();
    
    // Проверяем, что доставка не раньше сегодня
    if (deliveryDate < today) {
        showNotification('Das Lieferdatum kann nicht in der Vergangenheit liegen.', 'error');
        return;
    }
    
    // Проверяем, что забор не раньше доставки
    if (returnDate <= deliveryDate) {
        showNotification('Das Rückgabedatum muss nach dem Lieferdatum liegen.', 'error');
        return;
    }
    
    // Получаем даты аренды из корзины для дополнительной валидации
    const cartItems = document.querySelectorAll('[data-start-date][data-end-date]');
    if (cartItems.length > 0) {
        const firstItem = cartItems[0];
        const rentalStartDate = new Date(firstItem.getAttribute('data-start-date'));
        const rentalEndDate = new Date(firstItem.getAttribute('data-end-date'));
        
        // Проверяем, что доставка не позже первого дня аренды
        if (deliveryDate.toDateString() > rentalStartDate.toDateString()) {
            showNotification('Das Lieferdatum kann nicht nach dem ersten Tag der Miete liegen.', 'error');
            return;
        }
        
        // Проверяем, что забор не раньше последнего дня аренды
        if (returnDate.toDateString() < rentalEndDate.toDateString()) {
            showNotification('Das Rückgabedatum kann nicht vor dem letzten Tag der Miete liegen.', 'error');
            return;
        }
    }
    
    // Показываем индикатор загрузки
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Wird gespeichert...';
    submitBtn.disabled = true;
    
    fetch('{% url "main:update_delivery_details" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken(),
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
            .then(result => {
            if (result.success) {
                showNotification(result.message, 'success');
                closeDeliveryDetailsModal();
                
                // НЕ переключаем автоматически на delivery - пользователь сам выбирает
                // Показываем подсказку о том, что детали сохранены
                showNotification('Details gespeichert! Wählen Sie "Lieferung + Aufbau/Abbau" um diese zu verwenden.', 'success');
                
                // Перезагружаем страницу для обновления данных
                location.reload();
            } else {
                showNotification(result.error, 'error');
            }
        })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Fehler beim Speichern der Lieferdetails', 'error');
    })
    .finally(() => {
        // Восстанавливаем кнопку
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
    // Способ доставки не сбрасывается при сохранении деталей доставки
}

</script>
{% endblock %} 
